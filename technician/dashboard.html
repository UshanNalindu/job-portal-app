<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Technician Dashboard</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root{
  --bg-primary:#0f172a;
  --bg-secondary:#1e293b;
  --glass-bg:rgba(255,255,255,0.08);
  --glass-border:rgba(255,255,255,0.12);

  --primary:#3b82f6;
  --primary-gradient:linear-gradient(135deg,#3b82f6,#6366f1);

  --success:#22c55e;
  --warning:#f59e0b;
  --danger:#ef4444;
  --info:#0ea5e9;

  --text-light:#94a3b8;
  --text-dark:#0f172a;

  --radius-lg:20px;
  --radius-md:14px;
  --radius-sm:10px;

  --shadow-soft:0 10px 40px rgba(0,0,0,0.25);
  --shadow-hover:0 20px 60px rgba(0,0,0,0.35);
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
}

body{
  font-family:'Inter',sans-serif;
  background: radial-gradient(circle at 20% 30%,#1e293b,#0f172a 70%);
  color:#fff;
  min-height:100vh;
  overflow-x:hidden;
}

/* ================= HEADER ================= */

header{
  backdrop-filter:blur(18px);
  background:var(--glass-bg);
  border-bottom:1px solid var(--glass-border);
  padding:22px 35px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:100;
}

header h2{
  font-weight:600;
  font-size:20px;
  letter-spacing:0.5px;
}

header span{
  font-size:13px;
  color:var(--text-light);
}

header button{
  background:var(--danger);
  border:none;
  padding:8px 16px;
  border-radius:var(--radius-sm);
  color:#fff;
  font-weight:500;
  cursor:pointer;
  transition:all 0.3s ease;
}

header button:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 25px rgba(239,68,68,0.4);
}

/* ================= CONTAINER ================= */

.container{
  max-width:1300px;
  margin:auto;
  padding:40px 30px;
}

/* ================= EARNINGS ================= */

.earnings-section{
  background:var(--glass-bg);
  backdrop-filter:blur(16px);
  border:1px solid var(--glass-border);
  border-radius:var(--radius-lg);
  padding:25px;
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:25px;
  margin-bottom:35px;
  box-shadow:var(--shadow-soft);
}

.earnings-section strong{
  font-size:13px;
  color:var(--text-light);
  text-transform:uppercase;
  letter-spacing:1px;
}

.earnings-section span{
  display:block;
  margin-top:5px;
  font-size:24px;
  font-weight:700;
  background:var(--primary-gradient);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.earnings-section select{
  padding:10px 14px;
  border-radius:var(--radius-sm);
  border:none;
  outline:none;
  background:#fff;
  font-weight:500;
}

/* ================= TABS ================= */

.tabs{
  display:flex;
  gap:15px;
  margin-bottom:30px;
}

.tab-btn{
  padding:10px 20px;
  border-radius:50px;
  border:1px solid var(--glass-border);
  background:var(--glass-bg);
  color:#fff;
  font-weight:500;
  cursor:pointer;
  transition:all 0.3s ease;
}

.tab-btn:hover{
  background:rgba(255,255,255,0.15);
  transform:translateY(-2px);
}

.tab-btn.active{
  background:var(--primary-gradient);
  border:none;
  box-shadow:0 10px 30px rgba(59,130,246,0.4);
}

.tab-content{display:none;}
.tab-content.active{display:block;}

/* ================= JOB GRID ================= */

#assignedJobs,
#acceptedJobs,
#completedJobs{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:25px;
}

/* ================= JOB CARD ================= */

.job-card{
  background:var(--glass-bg);
  backdrop-filter:blur(20px);
  border:1px solid var(--glass-border);
  border-radius:var(--radius-lg);
  padding:22px;
  box-shadow:var(--shadow-soft);
  transition:all 0.4s ease;
  position:relative;
  overflow:hidden;
}

.job-card::before{
  content:"";
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:4px;
  background:var(--primary-gradient);
}

.job-card:hover{
  transform:translateY(-8px);
  box-shadow:var(--shadow-hover);
}

.job-card h4{
  font-size:17px;
  font-weight:600;
  margin-bottom:10px;
}

.job-card p{
  font-size:13px;
  color:var(--text-light);
  margin-bottom:6px;
}

/* ================= STATUS BADGES ================= */

.status{
  padding:6px 12px;
  border-radius:30px;
  font-size:11px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:1px;
  display:inline-block;
  animation:fadeIn 0.4s ease;
}

.status.pending{background:var(--warning);color:#fff;}
.status.accepted{background:var(--success);color:#fff;}
.status.completed{background:var(--info);color:#fff;}

/* ================= BUTTONS ================= */

button.accept,
button.complete{
  margin-top:12px;
  padding:9px 16px;
  border:none;
  border-radius:var(--radius-sm);
  font-weight:500;
  cursor:pointer;
  transition:all 0.3s ease;
}

button.accept{
  background:var(--success);
  color:#fff;
}

button.accept:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 25px rgba(34,197,94,0.4);
}

button.complete{
  background:var(--primary);
  color:#fff;
}

button.complete:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 25px rgba(59,130,246,0.4);
}

/* ================= ANIMATIONS ================= */

@keyframes fadeIn{
  from{opacity:0; transform:translateY(5px);}
  to{opacity:1; transform:translateY(0);}
}

/* ================= RESPONSIVE ================= */

@media(max-width:768px){
  header{
    flex-direction:column;
    align-items:flex-start;
    gap:12px;
  }

  .tabs{
    flex-direction:column;
  }

  .tab-btn{
    width:100%;
    text-align:center;
  }

  .earnings-section{
    flex-direction:column;
  }

  button.accept,
  button.complete{
    width:100%;
  }
}
</style>
</head>
<body>

<header>
  <h2>Technician Dashboard</h2>
  <span id="techEmailDisplay"></span>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">

  <!-- Earnings Display -->
  <div class="earnings-section">
    <div><strong>Technician Earnings:</strong> <span id="earningsDisplay">$0.00</span></div>
    <div><strong>Admin Share:</strong> <span id="adminShareDisplay">$0.00</span></div>
    <select id="earningPeriod" onchange="loadEarnings(); loadAdminShare();">
      <option value="daily">Today</option>
      <option value="weekly">This Week</option>
      <option value="monthly">This Month</option>
    </select>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('assignedJobsTab')">Jobs</button>
    <button class="tab-btn" onclick="showTab('acceptedJobsTab')">Accepted Jobs</button>
    <button class="tab-btn" onclick="showTab('completedJobsTab')">Completed Jobs</button>
  </div>

  <!-- Job Tabs -->
  <div id="assignedJobsTab" class="tab-content active">
    <div id="assignedJobs"></div>
  </div>

  <div id="acceptedJobsTab" class="tab-content">
    <div id="acceptedJobs"></div>
  </div>

  <div id="completedJobsTab" class="tab-content">
    <div id="completedJobs"></div>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAGjRba9QmovE8MSlvJTPSkKp7OsdbiqBw",
  authDomain: "service-booking-app-56dea.firebaseapp.com",
  projectId: "service-booking-app-56dea",
  storageBucket: "service-booking-app-56dea.appspot.com",
  messagingSenderId: "524636158231",
  appId: "1:524636158231:web:f5c22b993a23d0b4b21f52"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUserEmail = "";
let currentUserDistrict = "";

firebase.auth().onAuthStateChanged(async user=>{
  if(!user){ window.location.href="../login.html"; return; }
  currentUserEmail = user.email.trim().toLowerCase();
  document.getElementById("techEmailDisplay").innerText = currentUserEmail;

  const userDoc = await db.collection("users").doc(user.uid).get();
  const userData = userDoc.data() || {};
  currentUserDistrict = userData.district || "";
  
  loadJobs();
  loadEarnings();
  loadAdminShare();
});

function logout(){
  firebase.auth().signOut().then(()=>window.location.href="../login.html");
}

function showTab(tabId){
  document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');

  document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active'));
  event.currentTarget.classList.add('active');
}

// Accept / Reject Job
async function respondJob(jobId, response) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  if (response === "accepted" && !confirm("Accept this job?")) return;

  const jobRef = db.collection("jobs").doc(jobId);
  const jobSnap = await jobRef.get();
  if(!jobSnap.exists) return;

  const jobData = jobSnap.data();
  const price = Number(jobData.price) || 0;

  let updateObj = {
    status: response,
    technician: currentUserEmail
  };

  if (response === "accepted") {
    updateObj.assignedAt = firebase.firestore.FieldValue.serverTimestamp();
  }

  await jobRef.update(updateObj);

  if(response === "accepted"){
    const techRef = db.collection("users").doc(user.uid);

    // ✅ Fixed: Increment adminDue and earnings
    await techRef.update({
  "earnings.daily": firebase.firestore.FieldValue.increment(price * 0.9),
  "earnings.weekly": firebase.firestore.FieldValue.increment(price * 0.9),
  "earnings.monthly": firebase.firestore.FieldValue.increment(price * 0.9),
  "adminDue": firebase.firestore.FieldValue.increment(price * 0.1)
});


    loadEarnings();
    loadAdminShare();
    showTab('acceptedJobsTab');
  }

  loadJobs();
}

// Complete Job
function completeJob(jobId){
  if(!confirm("Mark this job as completed?")) return;
  db.collection("jobs").doc(jobId).update({
    status:"completed",
    completedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>loadJobs()).catch(err=>alert(err.message));
}

async function loadJobs() {
  const assignedContainer = document.getElementById("assignedJobs");
  const acceptedContainer = document.getElementById("acceptedJobs");
  const completedContainer = document.getElementById("completedJobs");

  const user = firebase.auth().currentUser;
  if (!user) return;

  const userDoc = await db.collection("users").doc(user.uid).get();
  if (!userDoc.exists) return;

  const techData = userDoc.data();
  const currentUserEmail = user.email.toLowerCase();
  //const currentUserDistrict = techData.district || "";

  // ❌ If technician is blocked, stop
  if (techData.blocked) {
    assignedContainer.innerHTML = "<p class='job-card'>You are blocked by admin. Cannot view jobs.</p>";
    acceptedContainer.innerHTML = "<p class='job-card'>You are blocked by admin. Cannot view jobs.</p>";
    completedContainer.innerHTML = "<p class='job-card'>You are blocked by admin. Cannot view jobs.</p>";
    return;
  }

  // =========================
  // Assigned jobs (pending)
  // =========================
  db.collection("jobs")
    .where("status", "==", "pending")
    .onSnapshot(async snapshot => {
      assignedContainer.innerHTML = "";

      let jobsToShow = [];

      for (const doc of snapshot.docs) {
        const job = doc.data();

        // ✅ Filter by district
        if (job.district !== currentUserDistrict) continue;

        // ✅ Skip if assigned to a blocked technician
        if (job.technicianUid) {
          const assignedTechDoc = await db.collection("users").doc(job.technicianUid).get();
          if (assignedTechDoc.exists && assignedTechDoc.data().blocked) continue;
        }

        jobsToShow.push({ id: doc.id, ...job });
      }

      if (jobsToShow.length === 0) {
        assignedContainer.innerHTML = "<p class='job-card'>No jobs available.</p>";
        return;
      }

      jobsToShow.forEach(job => {
        let createdOn = job.createdAt?.toDate?.() ? job.createdAt.toDate().toLocaleString() : "-";
        const div = document.createElement("div");
        div.className = "job-card";
        div.innerHTML = `
          <h4>Service: ${job.title}</h4>
          <p><b>District:</b> ${job.district}</p>
          <p><strong>Address:</strong> ${job.address}</p>
          <p><strong>Price:</strong> $${job.price}</p>
          <p><strong>Status:</strong> <span class="status pending">Pending</span></p>
          <p><strong>Created On:</strong> ${createdOn}</p>
          <button onclick="respondJob('${job.id}','accepted')" class="accept">Accept</button>
          
        `;
        assignedContainer.appendChild(div);
      });
    });

  // =========================
  // Accepted jobs
  // =========================
  db.collection("jobs")
    .where("technician", "==", currentUserEmail)
    .where("status", "==", "accepted")
    .onSnapshot(snapshot => {
      acceptedContainer.innerHTML = "";

      if (snapshot.empty) {
        acceptedContainer.innerHTML = "<p class='job-card'>No accepted jobs.</p>";
        return;
      }

      snapshot.docs.forEach(doc => {
        const job = doc.data();
        const div = document.createElement("div");
        div.className = "job-card";
        let assignedOn = job.assignedAt?.toDate?.() ? job.assignedAt.toDate().toLocaleString() : "-";
        div.innerHTML = `
          <h4>Service: ${job.title}</h4>
          <p><b>District:</b> ${job.district}</p>
          <p><strong>Address:</strong> ${job.address}</p>
          <p><strong>Price:</strong> $${job.price}</p>
          <p><strong>Status:</strong> <span class="status accepted">Accepted</span></p>
          <p><strong>Assigned On:</strong> ${assignedOn}</p>
          <button onclick="completeJob('${doc.id}')" class="complete">Mark as Completed</button>
        `;
        acceptedContainer.appendChild(div);
      });
    });

  // =========================
  // Completed jobs
  // =========================
  db.collection("jobs")
    .where("technician", "==", currentUserEmail)
    .where("status", "==", "completed")
    .onSnapshot(snapshot => {
      completedContainer.innerHTML = "";

      if (snapshot.empty) {
        completedContainer.innerHTML = "<p class='job-card'>No completed jobs.</p>";
        return;
      }

      snapshot.docs.forEach(doc => {
        const job = doc.data();
        const div = document.createElement("div");
        div.className = "job-card";
        let assignedOn = job.assignedAt?.toDate?.() ? job.assignedAt.toDate().toLocaleString() : "-";
        let completedOn = job.completedAt?.toDate?.() ? job.completedAt.toDate().toLocaleString() : "-";
        div.innerHTML = `
          <h4>Service: ${job.title}</h4>
          <p><b>District:</b> ${job.district}</p>
          <p><strong>Address:</strong> ${job.address}</p>
          <p><strong>Price:</strong> $${job.price}</p>
          <p><strong>Status:</strong> <span class="status completed">Completed</span></p>
          <p><strong>Assigned On:</strong> ${assignedOn}</p>
          <p><strong>Completed On:</strong> ${completedOn}</p>
        `;
        completedContainer.appendChild(div);
      });
    });
}


// Load Earnings
async function loadEarnings(){
  const user = firebase.auth().currentUser;
  if(!user) return;
  const period = document.getElementById("earningPeriod").value;
  try{
    const snap = await db.collection("users").doc(user.uid).get();
    const data = snap.data() || {};
    const earnings = data.earnings || {};
    const amount = earnings[period] || 0;
    document.getElementById("earningsDisplay").innerText = "₨" + Number(amount).toFixed(2);
  }catch(err){
    console.error(err);
    document.getElementById("earningsDisplay").innerText = "₨0.00";
  }
}

// Load Admin Share for current user only
// Real-time listener for adminDue updates
// Technician dashboard – listen to current user's document
firebase.auth().onAuthStateChanged(async user=>{
  if(!user){ 
    window.location.href="../login.html"; 
    return; 
  }

  currentUserEmail = user.email.trim().toLowerCase();
  document.getElementById("techEmailDisplay").innerText = currentUserEmail;

  const userRef = db.collection("users").doc(user.uid);

  // ✅ REAL-TIME LISTENER (FIXED)
  userRef.onSnapshot(docSnap => {
    if(docSnap.exists){
      const data = docSnap.data();
      const adminDue = data.adminDue || 0;

      document.getElementById("adminShareDisplay").innerText =
        "₨" + Number(adminDue).toFixed(2);

      const earnings = data.earnings || {};
      const period = document.getElementById("earningPeriod").value;
      const amount = earnings[period] || 0;

      document.getElementById("earningsDisplay").innerText =
        "₨" + Number(amount).toFixed(2);
    }
  });

  loadJobs();
});




</script>
</body>
</html>
